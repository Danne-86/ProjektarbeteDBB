<%
  const _isAuth = (typeof isAuthenticated !== 'undefined' && isAuthenticated) ? true : false;
  const _user = (typeof user !== 'undefined' && user) ? user : null;
  const _avatar = (_user && _user.avatar_url)
    ? _user.avatar_url
    : '/avatars/SpongeBob_SquarePants_character.png';
%>

<header class="w-full bg-white border-b border-gray-200">
  <!-- Top banner -->
  <div class="w-full bg-white">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-3">
      <p class="text-center font-semibold text-purple-700 text-[clamp(14px,2vw,20px)]">
        Where thoughts find their rhythm and words find their home
      </p>
    </div>
  </div>

  <!-- Main row: logo + actions -->
  <div class="mx-auto overflow-hidden max-w-7xl px-4 sm:px-6 max-h-20 lg:px-8 py-3 flex items-center justify-between gap-4 max-h-40">
    <a href="/" class="inline-flex items-center">
      <img src="logos/InkFlow_logo.jpg" alt="InkFlow" class=" select-none" />
      <span class="sr-only">Back to homepage</span>
    </a>

    <!-- Right side -->
    <% if (_isAuth) { %>
      <!-- Logged-in: avatar -->
      <div class="flex items-center gap-4">
        <a href="/profile" class="inline-flex items-center">
          <img
            src="<%= _avatar %>"
            alt="<%= _user ? _user.username : 'User' %> avatar"
            class="shrink-0 rounded-full object-cover object-center ring-1 ring-gray-300
                  size-10 sm:size-12" />
          <span class="sr-only">Profile</span>
        </a>
      </div>
    <% } else { %>
      <!-- Logged-out: desktop buttons -->
      <div class="hidden sm:flex items-center gap-2">
        <a href="#" data-modal-open="login"
           class="inline-flex items-center justify-center rounded-md px-5 py-2.5 bg-purple-700 text-white hover:bg-purple-800 shadow-sm">
          Login
        </a>
        <a href="#" data-modal-open="register"
           class="inline-flex items-center justify-center rounded-md px-5 py-2.5 border-2 border-purple-700 text-purple-700 hover:bg-purple-50">
          Register
        </a>
      </div>
    <% } %>
  </div>

  <!-- Desktop nav -->
  <nav class="bg-gray-50 border-t border-gray-200">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="hidden md:flex lg:hidden items-center justify-between py-3">
        <ul class="flex items-center space-x-8">
          <li><a href="/" class="text-gray-700 hover:text-gray-900">Home</a></li>
        </ul>
        <ul class="flex items-center space-x-8">
          <% if (_isAuth) { %>
            <li><a href="/" class="text-gray-700 hover:text-gray-900">New post</a></li>
            <li><a href="/profile" class="text-gray-700 hover:text-gray-900">Profile options</a></li>
            <li><a href="/" class="text-gray-700 hover:text-gray-900">Follower options</a></li>
            <li><a href="/logout" class="text-gray-700 hover:text-gray-900">Logout</a></li>
          <% } %>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ===== Mobile FAB hamburger + upward menu (mobile only) ===== -->
  <button
    id="fabBtn"
    class="sm:hidden fixed bottom-4 right-4 z-30 inline-flex items-center justify-center rounded-full border border-gray-300 shadow-lg bg-white hover:bg-gray-50 w-14 h-14"
    aria-controls="fabMenu"
    aria-expanded="false"
    aria-haspopup="true">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
         viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"/>
    </svg>
    <span class="sr-only">Open menu</span>
  </button>

  <!-- Backdrop for FAB menu -->
  <div id="fabBackdrop" class="sm:hidden fixed inset-0 z-20 hidden"></div>

  <!-- Upward popup menu -->
  <div id="fabMenu"
       class="sm:hidden fixed z-30 bottom-[4.25rem] right-4 w-56 origin-bottom-right transform
              rounded-xl border border-gray-200 bg-white shadow-xl
              opacity-0 scale-95 pointer-events-none transition ease-out duration-200">
    <ul class="py-2">
      <li><a href="/" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">Home</a></li>

      <% if (_isAuth) { %>
        <li><a href="/" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">New post</a></li>
        <li><a href="/profile" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">Profile options</a></li>
        <li><a href="/" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">Follower options</a></li>
        <li><a href="/logout" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">Logout</a></li>
      <% } else { %>
        <li><a href="#" data-modal-open="login" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">Login</a></li>
        <li><a href="#" data-modal-open="register" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">Register</a></li>
      <% } %>
    </ul>
  </div>

  <!-- ===== Auth Modals (only render when logged out) ===== -->
  <% if (!_isAuth) { %>
    <!-- Overlay for modals -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 hidden z-40"></div>

    <!-- Login Modal -->
    <div id="modal-login" class="fixed inset-0 z-50 hidden items-center justify-center px-4">
      <div class="mx-auto w-full max-w-2xl rounded-xl bg-[#eff1f7] shadow-xl ring-1 ring-gray-300">
        <div class="flex items-center justify-end px-4 pt-3">
          <button class="p-2 text-gray-700 hover:text-gray-900" data-modal-close aria-label="Close">✕</button>
        </div>
        <form method="POST" action="/login" class="px-8 pb-8">
          <div class="space-y-6">
            <div>
              <label for="login-email" class="block text-sm text-gray-700 mb-1">E-mail</label>
              <input id="login-email" name="email" type="email" required
                     class="w-full rounded-md border border-gray-300 bg-white p-2.5 outline-none focus:ring-2 focus:ring-purple-600" />
            </div>
            <div>
              <label for="login-password" class="block text-sm text-gray-700 mb-1">Password</label>
              <input id="login-password" name="password" type="password" required
                     class="w-full rounded-md border border-gray-300 bg-white p-2.5 outline-none focus:ring-2 focus:ring-purple-600" />
            </div>
          </div>
          <div class="mt-8 flex flex-col sm:flex-row sm:items-center gap-4">
            <button class="inline-flex justify-center rounded-md px-6 py-2.5 bg-purple-700 text-white hover:bg-purple-800">
              Login
            </button>
            <a href="#" data-modal-open="register"
               class="inline-flex justify-center rounded-md px-6 py-2.5 border-2 border-purple-700 text-purple-700 hover:bg-purple-50">
              Register
            </a>
          </div>
        </form>
      </div>
    </div>

    <!-- Register Modal -->
    <div id="modal-register" class="fixed inset-0 z-50 hidden items-center justify-center px-4">
      <div class="mx-auto w-full max-w-2xl rounded-xl bg-[#eff1f7] shadow-xl ring-1 ring-gray-300">
        <div class="flex items-center justify-end px-4 pt-3">
          <button class="p-2 text-gray-700 hover:text-gray-900" data-modal-close aria-label="Close">✕</button>
        </div>
        <form method="POST" action="/register" class="px-8 pb-8">
          <div class="space-y-5">
            <div>
              <label for="reg-email" class="block text-sm text-gray-700 mb-1">E-mail</label>
              <input id="reg-email" name="email" type="email" required
                     class="w-full rounded-md border border-gray-300 bg-white p-2.5 outline-none focus:ring-2 focus:ring-purple-600" />
            </div>
            <div>
              <label for="reg-username" class="block text-sm text-gray-700 mb-1">Username</label>
              <input id="reg-username" name="username" type="text" minlength="3" required
                     class="w-full rounded-md border border-gray-300 bg-white p-2.5 outline-none focus:ring-2 focus:ring-purple-600" />
            </div>
            <div>
              <label for="reg-newpass" class="block text-sm text-gray-700 mb-1">New password</label>
              <input id="reg-newpass" name="password" type="password" minlength="8" required
                     class="w-full rounded-md border border-gray-300 bg-white p-2.5 outline-none focus:ring-2 focus:ring-purple-600" />
            </div>
            <div>
              <label for="reg-conf" class="block text-sm text-gray-700 mb-1">Password</label>
              <input id="reg-conf" name="passwordConfirm" type="password" minlength="8" required
                     class="w-full rounded-md border border-gray-300 bg-white p-2.5 outline-none focus:ring-2 focus:ring-purple-600" />
            </div>
          </div>
          <div class="mt-8 flex flex-col sm:flex-row sm:items-center gap-4">
            <button class="inline-flex justify-center rounded-md px-6 py-2.5 bg-purple-700 text-white hover:bg-purple-800">
              Register
            </button>
            <a href="#" data-modal-open="login"
               class="inline-flex justify-center rounded-md px-6 py-2.5 border-2 border-purple-700 text-purple-700 hover:bg-purple-50">
              Login
            </a>
          </div>
        </form>
      </div>
    </div>
  <% } %>
</header>

<script>
  (function () {
    // ===== Mobile FAB menu =====
    const fabBtn = document.getElementById('fabBtn');
    const fabMenu = document.getElementById('fabMenu');
    const fabBackdrop = document.getElementById('fabBackdrop');

    function openFab() {
      if (!fabBtn || !fabMenu || !fabBackdrop) return;
      fabMenu.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
      fabBackdrop.classList.remove('hidden');
      fabBtn.setAttribute('aria-expanded', 'true');
    }
    function closeFab() {
      if (!fabBtn || !fabMenu || !fabBackdrop) return;
      fabMenu.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
      fabBackdrop.classList.add('hidden');
      fabBtn.setAttribute('aria-expanded', 'false');
    }
    function toggleFab() {
      const isOpen = fabBtn && fabBtn.getAttribute('aria-expanded') === 'true';
      if (isOpen) closeFab(); else openFab();
    }

    if (fabBtn) fabBtn.addEventListener('click', (e) => { e.preventDefault(); toggleFab(); });
    if (fabBackdrop) fabBackdrop.addEventListener('click', closeFab);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeFab(); });

    // Close on any menu link click
    if (fabMenu) {
      fabMenu.querySelectorAll('a').forEach(a => a.addEventListener('click', closeFab));
    }

    // Close FAB if resizing to >= sm
    const mq = window.matchMedia('(min-width: 640px)');
    if (mq && mq.addEventListener) mq.addEventListener('change', e => { if (e.matches) closeFab(); });

    // ===== Modals (exist only when logged out) =====
    const overlay = document.getElementById('modalOverlay');
    const loginModal = document.getElementById('modal-login');
    const registerModal = document.getElementById('modal-register');

    function openModal(modalEl) {
      if (!overlay || !modalEl) return;
      closeFab(); // ensure FAB menu is closed under modals
      overlay.classList.remove('hidden');
      modalEl.classList.remove('hidden');
      modalEl.classList.add('flex');
      document.documentElement.classList.add('overflow-hidden');
      const firstInput = modalEl.querySelector('input');
      if (firstInput) setTimeout(() => firstInput.focus(), 0);
    }
    function closeAllModals() {
      if (!overlay) return;
      overlay.classList.add('hidden');
      [loginModal, registerModal].forEach(m => { if (m) { m.classList.add('hidden'); m.classList.remove('flex'); } });
      document.documentElement.classList.remove('overflow-hidden');
    }
    function switchTo(name) {
      closeAllModals();
      if (name === 'login') openModal(loginModal);
      if (name === 'register') openModal(registerModal);
    }

    document.querySelectorAll('[data-modal-open]').forEach(el => {
      el.addEventListener('click', e => {
        e.preventDefault();
        const name = el.getAttribute('data-modal-open');
        switchTo(name);
      });
    });
    document.querySelectorAll('[data-modal-close]').forEach(el => el.addEventListener('click', e => { e.preventDefault(); closeAllModals(); }));
    if (overlay) overlay.addEventListener('click', closeAllModals);
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAllModals(); });
  })();
</script>
